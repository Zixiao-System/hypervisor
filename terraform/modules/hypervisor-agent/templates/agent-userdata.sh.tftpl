#!/bin/bash
# =============================================================================
# Hypervisor Agent Initialization Script
# =============================================================================

set -e

# Configuration
HYPERVISOR_VERSION="${hypervisor_version}"
SERVER_ENDPOINT="${server_endpoint}"
ETCD_ENDPOINTS="${etcd_endpoints}"
AGENT_PORT="${agent_port}"
REGION="${region}"
ZONE="${zone}"
SUPPORTED_INSTANCE_TYPES="${supported_instance_types}"
LOG_LEVEL="${log_level}"
INSTALL_LIBVIRT="${install_libvirt}"
INSTALL_CONTAINERD="${install_containerd}"
INSTALL_FIRECRACKER="${install_firecracker}"

echo "=== Installing Prerequisites ==="

apt-get update
apt-get install -y curl wget jq

# Create hypervisor user
useradd -r -s /usr/sbin/nologin hypervisor || true
mkdir -p /etc/hypervisor /var/lib/hypervisor/{images,instances} /var/log/hypervisor
chown -R hypervisor:hypervisor /var/lib/hypervisor /var/log/hypervisor

%{ if install_libvirt == "true" }
echo "=== Installing libvirt (for VMs) ==="

apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virtinst
systemctl enable libvirtd
systemctl start libvirtd

# Add hypervisor user to libvirt group
usermod -aG libvirt hypervisor
usermod -aG kvm hypervisor
%{ endif }

%{ if install_containerd == "true" }
echo "=== Installing containerd (for Containers) ==="

apt-get install -y containerd
mkdir -p /etc/containerd
containerd config default > /etc/containerd/config.toml
systemctl enable containerd
systemctl restart containerd
%{ endif }

%{ if install_firecracker == "true" }
echo "=== Installing Firecracker (for MicroVMs) ==="

FIRECRACKER_VERSION="v1.5.0"
curl -sL "https://github.com/firecracker-microvm/firecracker/releases/download/$FIRECRACKER_VERSION/firecracker-$FIRECRACKER_VERSION-$(uname -m).tgz" -o /tmp/firecracker.tgz
tar xzf /tmp/firecracker.tgz -C /tmp
mv /tmp/release-$FIRECRACKER_VERSION-$(uname -m)/firecracker-$FIRECRACKER_VERSION-$(uname -m) /usr/local/bin/firecracker
chmod +x /usr/local/bin/firecracker
rm -rf /tmp/firecracker.tgz /tmp/release-*
%{ endif }

echo "=== Installing Hypervisor Agent ==="

# Download hypervisor-agent binary
ARCH=$(uname -m)
case $ARCH in
    x86_64) ARCH="amd64" ;;
    aarch64) ARCH="arm64" ;;
esac

if [ "$HYPERVISOR_VERSION" = "latest" ]; then
    DOWNLOAD_URL="https://github.com/your-org/hypervisor/releases/latest/download/hypervisor-agent-linux-$ARCH"
else
    DOWNLOAD_URL="https://github.com/your-org/hypervisor/releases/download/$HYPERVISOR_VERSION/hypervisor-agent-linux-$ARCH"
fi

echo "Downloading from: $DOWNLOAD_URL"
curl -sL "$DOWNLOAD_URL" -o /usr/local/bin/hypervisor-agent || {
    echo "Failed to download, using placeholder"
    echo '#!/bin/bash' > /usr/local/bin/hypervisor-agent
    echo 'echo "Placeholder - replace with actual binary"' >> /usr/local/bin/hypervisor-agent
}
chmod +x /usr/local/bin/hypervisor-agent

echo "=== Configuring Hypervisor Agent ==="

# Get hostname and IP
HOSTNAME=$(hostname)
PRIVATE_IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4 || hostname -I | awk '{print $1}')

# Create configuration file
cat > /etc/hypervisor/agent.yaml <<EOF
# Hypervisor Agent Configuration
# Generated by Terraform

port: $AGENT_PORT
role: worker
region: $REGION
zone: $ZONE
server_addr: "$SERVER_ENDPOINT"

supported_instance_types:
$(echo "$SUPPORTED_INSTANCE_TYPES" | tr ',' '\n' | while read t; do echo "  - $t"; done)

etcd:
  endpoints:
$(echo "$ETCD_ENDPOINTS" | tr ',' '\n' | while read ep; do echo "    - \"$ep\""; done)

%{ if install_libvirt == "true" }
libvirt:
  uri: "qemu:///system"
  image_path: /var/lib/hypervisor/images
%{ endif }

%{ if install_containerd == "true" }
containerd:
  address: "/run/containerd/containerd.sock"
  namespace: "hypervisor"
%{ endif }

%{ if install_firecracker == "true" }
firecracker:
  binary_path: /usr/local/bin/firecracker
  kernel_path: /var/lib/hypervisor/kernels
%{ endif }

log_level: $LOG_LEVEL
EOF

chown hypervisor:hypervisor /etc/hypervisor/agent.yaml
chmod 640 /etc/hypervisor/agent.yaml

# Create systemd service
cat > /etc/systemd/system/hypervisor-agent.service <<EOF
[Unit]
Description=Hypervisor Agent (Compute Node)
Documentation=https://github.com/your-org/hypervisor
After=network.target libvirtd.service containerd.service
Wants=network-online.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/hypervisor-agent --config /etc/hypervisor/agent.yaml
Restart=always
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

echo "=== Starting Hypervisor Agent ==="

systemctl daemon-reload
systemctl enable hypervisor-agent
systemctl start hypervisor-agent

echo "=== Hypervisor Agent installation complete ==="
