name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  GO_VERSION: '1.24'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

      - name: Generate protobuf
        run: make proto

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

  test:
    name: Test
    runs-on: ubuntu-latest
    services:
      etcd:
        image: quay.io/coreos/etcd:v3.5.9
        ports:
          - 2379:2379
        env:
          ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
          ETCD_ADVERTISE_CLIENT_URLS: http://localhost:2379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download Go modules
        run: go mod download

      - name: Generate protobuf
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          make proto

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...
        env:
          ETCD_ENDPOINTS: localhost:2379

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.out
          fail_ci_if_error: false

  build-linux-vdi-agent:
    name: Build Linux VDI Agent
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxext-dev libxrandr-dev libpulse-dev

      - name: Build
        working-directory: pkg/virtual-apps-and-desktop/guest_drivers/linux/zixiao-vdi-agent
        run: make

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-vdi-agent
          path: pkg/virtual-apps-and-desktop/guest_drivers/linux/zixiao-vdi-agent/bin/

  build-windows-drivers:
    name: Build and Sign Windows VirtIO Drivers (${{ matrix.platform }}, ${{ matrix.configuration }})
    runs-on: windows-latest
    # Mark as optional - WDK installation is complex and may fail
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        platform: [x64, ARM64]
        configuration: [Release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install WDK
        run: |
          # Install WDK via winget (Windows Package Manager)
          winget install --id Microsoft.WindowsWDK --version 10.0.26100 --accept-source-agreements --accept-package-agreements --silent
        continue-on-error: true

      - name: Build zviopci
        run: msbuild clib/guest-drivers/windows/zviopci/zviopci.vcxproj /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }}

      - name: Build zvioblk
        run: msbuild clib/guest-drivers/windows/zvioblk/zvioblk.vcxproj /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }}

      - name: Build zvionet
        run: msbuild clib/guest-drivers/windows/zvionet/zvionet.vcxproj /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }}

      - name: Build zviobln
        run: msbuild clib/guest-drivers/windows/zviobln/zviobln.vcxproj /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }}

      - name: Generate CI signing certificate
        shell: pwsh
        run: |
          # Generate a short-lived self-signed certificate for CI builds
          $cert = New-SelfSignedCertificate `
            -Subject "CN=Zixiao CI Driver Signing, O=Zixiao System, C=CN" `
            -Type CodeSigningCert `
            -KeySpec Signature `
            -KeyExportPolicy Exportable `
            -KeyLength 4096 `
            -HashAlgorithm SHA256 `
            -NotAfter (Get-Date).AddDays(1) `
            -CertStoreLocation "Cert:\CurrentUser\My" `
            -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3,1.3.6.1.4.1.311.10.3.6")

          # Save thumbprint for signing step
          echo "CERT_THUMBPRINT=$($cert.Thumbprint)" >> $env:GITHUB_ENV

          # Export public certificate for distribution
          $certsDir = "clib/guest-drivers/windows/certs"
          New-Item -ItemType Directory -Force -Path $certsDir | Out-Null
          Export-Certificate -Cert $cert -FilePath "$certsDir/zixiao-driver-signing.cer" -Type CERT
          $cert.Thumbprint | Out-File -FilePath "$certsDir/thumbprint.txt" -Encoding ASCII -NoNewline

          Write-Host "Certificate generated with thumbprint: $($cert.Thumbprint)"

      - name: Sign drivers
        shell: pwsh
        run: |
          cd clib/guest-drivers/windows/signing
          .\sign-drivers.ps1 -CertThumbprint $env:CERT_THUMBPRINT -Platform ${{ matrix.platform }} -Configuration ${{ matrix.configuration }}

      - name: Create driver package
        shell: pwsh
        run: |
          $platform = "${{ matrix.platform }}"
          $config = "${{ matrix.configuration }}"
          $version = if ($env:GITHUB_REF -match 'refs/tags/v(.+)') { $matches[1] } else { "0.0.0-dev" }
          $packageName = "zixiao-virtio-drivers-$version-$platform"
          $packageDir = "dist/$packageName"

          # Create package directory structure
          New-Item -ItemType Directory -Force -Path $packageDir | Out-Null
          New-Item -ItemType Directory -Force -Path "$packageDir/certs" | Out-Null
          New-Item -ItemType Directory -Force -Path "$packageDir/installer" | Out-Null

          # Copy drivers
          $drivers = @("zviopci", "zvioblk", "zvionet", "zviobln")
          foreach ($driver in $drivers) {
            $srcDir = "clib/guest-drivers/windows/$driver/$platform/$config"
            $dstDir = "$packageDir/$driver"
            if (Test-Path $srcDir) {
              New-Item -ItemType Directory -Force -Path $dstDir | Out-Null
              Copy-Item "$srcDir/*" $dstDir -Recurse -Force
            }
            # Copy INF file
            $infSrc = "clib/guest-drivers/windows/$driver/$driver.inf"
            if (Test-Path $infSrc) {
              Copy-Item $infSrc $dstDir -Force
            }
          }

          # Copy certificate and installer
          Copy-Item "clib/guest-drivers/windows/certs/*" "$packageDir/certs" -Force
          Copy-Item "clib/guest-drivers/windows/installer/*" "$packageDir/installer" -Force
          Copy-Item "clib/guest-drivers/windows/README.md" $packageDir -Force

          # Create ZIP archive
          Compress-Archive -Path $packageDir -DestinationPath "dist/$packageName.zip" -Force
          Write-Host "Created package: dist/$packageName.zip"

      - name: Upload driver package
        uses: actions/upload-artifact@v4
        with:
          name: windows-drivers-${{ matrix.platform }}
          path: |
            dist/*.zip

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test, build-linux-vdi-agent]
    # Note: build-windows-drivers is optional and doesn't block this job

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

      - name: Generate protobuf
        run: make proto

      - name: Build binaries (linux/amd64)
        run: |
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-s -w" -o bin/hypervisor-server-linux-amd64 ./cmd/hypervisor-server
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-s -w" -o bin/hypervisor-agent-linux-amd64 ./cmd/hypervisor-agent
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-s -w" -o bin/hypervisor-ctl-linux-amd64 ./cmd/hypervisor-ctl

      - name: Build binaries (linux/arm64)
        run: |
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags "-s -w" -o bin/hypervisor-server-linux-arm64 ./cmd/hypervisor-server
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags "-s -w" -o bin/hypervisor-agent-linux-arm64 ./cmd/hypervisor-agent
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags "-s -w" -o bin/hypervisor-ctl-linux-arm64 ./cmd/hypervisor-ctl

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: bin/

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: bin/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: bin/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}