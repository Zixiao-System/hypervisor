name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  GO_VERSION: '1.24'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

      - name: Generate protobuf
        run: make proto

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

  test:
    name: Test
    runs-on: ubuntu-latest
    services:
      etcd:
        image: quay.io/coreos/etcd:v3.5.9
        ports:
          - 2379:2379
        env:
          ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
          ETCD_ADVERTISE_CLIENT_URLS: http://localhost:2379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download Go modules
        run: go mod download

      - name: Generate protobuf
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          make proto

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...
        env:
          ETCD_ENDPOINTS: localhost:2379

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.out
          fail_ci_if_error: false

  build-linux-vdi-agent:
    name: Build Linux VDI Agent
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxext-dev libxrandr-dev libpulse-dev

      - name: Build
        working-directory: pkg/virtual-apps-and-desktop/guest_drivers/linux/zixiao-vdi-agent
        run: make

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-vdi-agent
          path: pkg/virtual-apps-and-desktop/guest_drivers/linux/zixiao-vdi-agent/bin/

  build-windows-drivers:
    name: Build Windows VirtIO Drivers (${{ matrix.platform }}, ${{ matrix.configuration }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [x64, ARM64]
        configuration: [Release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install WDK
        run: |
          # Download and install WDK 11
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://go.microsoft.com/fwlink/?linkid=2286082" -OutFile "$env:TEMP\wdksetup.exe"
          Start-Process -Wait -FilePath "$env:TEMP\wdksetup.exe" -ArgumentList "/features + /q /norestart"
          # Install WDK VS extension
          $wdkVsix = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Vsix\*\WDK.vsix" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($wdkVsix) {
            $vsixInstaller = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\VSIXInstaller.exe"
            if (Test-Path $vsixInstaller) {
              Start-Process -Wait -FilePath $vsixInstaller -ArgumentList "/q", $wdkVsix.FullName
            }
          }

      - name: Build zviopci
        run: msbuild clib/guest-drivers/windows/zviopci/zviopci.vcxproj /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }}

      - name: Build zvioblk
        run: msbuild clib/guest-drivers/windows/zvioblk/zvioblk.vcxproj /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }}

      - name: Build zvionet
        run: msbuild clib/guest-drivers/windows/zvionet/zvionet.vcxproj /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }}

      - name: Build zviobln
        run: msbuild clib/guest-drivers/windows/zviobln/zviobln.vcxproj /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }}

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test, build-linux-vdi-agent, build-windows-drivers]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

      - name: Generate protobuf
        run: make proto

      - name: Build binaries (linux/amd64)
        run: |
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-s -w" -o bin/hypervisor-server-linux-amd64 ./cmd/hypervisor-server
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-s -w" -o bin/hypervisor-agent-linux-amd64 ./cmd/hypervisor-agent
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-s -w" -o bin/hypervisor-ctl-linux-amd64 ./cmd/hypervisor-ctl

      - name: Build binaries (linux/arm64)
        run: |
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags "-s -w" -o bin/hypervisor-server-linux-arm64 ./cmd/hypervisor-server
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags "-s -w" -o bin/hypervisor-agent-linux-arm64 ./cmd/hypervisor-agent
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags "-s -w" -o bin/hypervisor-ctl-linux-arm64 ./cmd/hypervisor-ctl

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: bin/

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: bin/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: bin/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}